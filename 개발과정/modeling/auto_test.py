question = {}
question['prof_0_index_0'] = ['배준현 교수님 어때?']
question['prof_0_index_1'] = ['배준현 교수님 어떻고 시험 어때?', '배준현 교수님 어떻고 과제 어때?', '배준현 교수님 어떻고 팀플 어때?', '배준현 교수님 어떻고 출석 어때?']
question['prof_0_index_2'] = ['배준현 교수님 어떻고 시험 어떻고 과제 어때?', '배준현 교수님 어떻고 시험 어떻고 팀플 어때?', '배준현 교수님 어떻고 시험 어떻고 출석 어때?', '배준현 교수님 어떻고 과제 어떻고 팀플 어때?', '배준현 교수님 어떻고 과제 어떻고 출석 어때?', '배준현 교수님 어떻고 팀플 어떻고 출석 어때?']
question['prof_0_index_3'] = ['배준현 교수님 어떻고 시험 어떻고 과제 어떻고 팀플 어때?', '배준현 교수님 어떻고 시험 어떻고 과제 어떻고 출석 어때?', '배준현 교수님 어떻고 시험 어떻고 팀플 어떻고 출석 어때?', '배준현 교수님 어떻고 과제 어떻고 팀플 어떻고 출석 어때?']
question['prof_0_index_4'] = ['배준현 교수님 어떻고 시험 어떻고 과제 어떻고 팀플 어떻고 출석 어때?']

question['prof_1_index_1'] = ['배준현 교수님 어때? 시험 어때?', '배준현 교수님 어때? 과제 어때?', '배준현 교수님 어때? 팀플 어때?', '배준현 교수님 어때? 출석 어때?']
question['prof_1_index_2'] = ['배준현 교수님 어때? 시험 어때? 과제 어때?', '배준현 교수님 어때? 시험 어때? 팀플 어때?', '배준현 교수님 어때? 시험 어때? 출석 어때?', '배준현 교수님 어때? 과제 어때? 팀플 어때?', '배준현 교수님 어때? 과제 어때? 출석 어때?', '배준현 교수님 어때? 팀플 어때? 출석 어때?']
question['prof_1_index_3']= ['배준현 교수님 어때? 시험 어때? 과제 어때? 팀플 어때?', '배준현 교수님 어때? 시험 어때? 과제 어때? 출석 어때?', '배준현 교수님 어때? 시험 어때? 팀플 어때? 출석 어때?', '배준현 교수님 어때? 과제 어때? 팀플 어때? 출석 어때?']
question['prof_1_index_4']= ['배준현 교수님 어때? 시험 어때? 과제 어때? 팀플 어때? 출석 어때?']

question['course_0_index_0'] = ['프로그래밍기초 수업 어때?']
question['course_0_index_1'] = ['프로그래밍기초 수업 어떻고 시험 어때?', '프로그래밍기초 수업 어떻고 과제 어때?', '프로그래밍기초 수업 어떻고 팀플 어때?', '프로그래밍기초 수업 어떻고 출석 어때?']
question['course_0_index_2'] = ['프로그래밍기초 수업 어떻고 시험 어떻고 과제 어때?', '프로그래밍기초 수업 어떻고 시험 어때? 팀플 어때?', '프로그래밍기초 수업 어떻고 시험 어떻고 출석 어때?', '프로그래밍기초 수업 어떻고 과제 어떻고 팀플 어때?', '프로그래밍기초 수업 어떻고 과제 어떻고 출석 어때?', '프로그래밍기초 수업 어떻고 팀플 어떻고 출석 어때?']
question['course_0_index_3'] = ['프로그래밍기초 수업 어떻고 시험 어떻고 과제 어떻고 팀플 어때?', '프로그래밍기초 수업 어떻고 시험 어떻고 과제 어떻고 출석 어때?', '프로그래밍기초 수업 어떻고 시험 어떻고 팀플 어떻고 출석 어때?', '프로그래밍기초 수업 어떻고 과제 어떻고 팀플 어떻고 출석 어때?']
question['course_0_index_4'] = ['프로그래밍기초 수업 어떻고 시험 어떻고 과제 어떻고 팀플 어떻고 출석 어때?']

question['course_1_index_1'] = ['프로그래밍기초 수업 어때? 시험 어때?', '프로그래밍기초 수업 어때? 과제 어때?', '프로그래밍기초 수업 어때? 팀플 어때?', '프로그래밍기초 수업 어때? 출석 어때?']
question['course_1_index_2'] = ['프로그래밍기초 수업 어때? 시험 어때? 과제 어때?', '프로그래밍기초 수업 어때? 시험 어때? 팀플 어때?', '프로그래밍기초 수업 어때? 시험 어때? 출석 어때?', '프로그래밍기초 수업 어때? 과제 어때? 팀플 어때?', '프로그래밍기초 수업 어때? 과제 어때? 출석 어때?', '프로그래밍기초 수업 어때? 팀플 어때? 출석 어때?']
question['course_1_index_3'] = ['프로그래밍기초 수업 어때? 시험 어때? 과제 어때? 팀플 어때?', '프로그래밍기초 수업 어때? 시험 어때? 과제 어때? 출석 어때?', '프로그래밍기초 수업 어때? 시험 어때? 팀플 어때? 출석 어때?', '프로그래밍기초 수업 어때? 과제 어때? 팀플 어때? 출석 어때?']
question['course_1_index_4'] = ['프로그래밍기초 수업 어때? 시험 어때? 과제 어때? 팀플 어때? 출석 어때?']

question['profNcourse_0_index_0'] = ['배준현 교수님 프로그래밍기초 수업 어때?']
question['profNcourse_0_index_1'] = ['배준현 교수님 프로그래밍기초 수업 어떻고 시험 어때?', '배준현 교수님 프로그래밍기초 수업 어떻고 과제 어때?', '배준현 교수님 프로그래밍기초 수업 어떻고 팀플 어때?', '배준현 교수님 프로그래밍기초 수업 어떻고 출석 어때?']
question['profNcourse_0_index_2'] = ['배준현 교수님 프로그래밍기초 수업 어떻고 시험 어떻고 과제 어때?', '배준현 교수님 프로그래밍기초 수업 어떻고 시험 어떻고 팀플 어때?', '배준현 교수님 프로그래밍기초 수업 어떻고 시험 어떻고 출석 어때?', '배준현 교수님 프로그래밍기초 수업 어떻고 과제 어떻고 팀플 어때?', '배준현 교수님 프로그래밍기초 수업 어떻고 과제 어떻고 출석 어때?', '배준현 교수님 프로그래밍기초 수업 어떻고 팀플 어떻고 출석 어때?']
question['profNcourse_0_index_3'] = ['배준현 교수님 프로그래밍기초 수업 어떻고 시험 어떻고 과제 어떻고 팀플 어때?', '배준현 교수님 프로그래밍기초 수업 어떻고 시험 어떻고 과제 어떻고 출석 어때?', '배준현 교수님 프로그래밍기초 수업 어떻고 시험 어떻고 팀플 어떻고 출석 어때?', '배준현 교수님 프로그래밍기초 수업 어떻고 과제 어떻고 팀플 어떻고 출석 어때?']
question['profNcourse_0_index_4'] = ['배준현 교수님 프로그래밍기초 수업 어떻고 시험 어떻고 과제 어떻고 팀플 어떻고 출석 어때?']

question['profNcourse_1_index_1'] = ['배준현 교수님 프로그래밍기초 수업 어때? 시험 어때?', '배준현 교수님 프로그래밍기초 수업 어때? 과제 어때?', '배준현 교수님 프로그래밍기초 수업 어때? 팀플 어때?', '배준현 교수님 프로그래밍기초 수업 어때? 출석 어때?']
question['profNcourse_1_index_2'] = ['배준현 교수님 프로그래밍기초 수업 어때? 시험 어때? 과제 어때?', '배준현 교수님 프로그래밍기초 수업 어때? 시험 어때? 팀플 어때?', '배준현 교수님 프로그래밍기초 수업 어때? 시험 어때? 출석 어때?', '배준현 교수님 프로그래밍기초 수업 어때? 과제 어때? 팀플 어때?', '배준현 교수님 프로그래밍기초 수업 어때? 과제 어때? 출석 어때?', '배준현 교수님 프로그래밍기초 수업 어때? 팀플 어때? 출석 어때?']
question['profNcourse_1_index_3'] = ['배준현 교수님 프로그래밍기초 수업 어때? 시험 어때? 과제 어때? 팀플 어때?', '배준현 교수님 프로그래밍기초 수업 어때? 시험 어때? 과제 어때? 출석 어때?', '배준현 교수님 프로그래밍기초 수업 어때? 시험 어때? 팀플 어때? 출석 어때?', '배준현 교수님 프로그래밍기초 수업 어때? 과제 어때? 팀플 어때? 출석 어때?']
question['profNcourse_1_index_4'] = ['배준현 교수님 프로그래밍기초 수업 어때? 시험 어때? 과제 어때? 팀플 어때? 출석 어때?']

experiment = {}
experiment['과목명'] = {}
experiment['교수명'] = {}
experiment['과목명+교수명'] = {}
num_sen = ['문장1', '여러문장']

for key in experiment.keys() :
  for sen in num_sen :
    experiment[key][sen] = {}
    for i in range(5):
      experiment[key][sen][i] = {}
print(experiment)

chat_model = ChatModel.from_pretrained("chat-bison@001")  #chat model 불러오기
print(type(chat_model))

format = ['교수명','과목명','과목명+교수명']
num_sen = ['문장1', '여러문장']
for f in format :
  if f == '교수명' : arr = 'prof_'
  elif f == '과목명' : arr = 'course_'
  elif f == '과목명+교수명' : arr = 'profNcourse_'

  for i in range(2) :
    bef_f = arr + f'{i}_index_'
    for j in range(i, 5) :
      last_arr = bef_f + str(j)

      for query_text in question[last_arr] :
        print(query_text)
        chat = chat_model.start_chat(
          context="수업에 대해 궁금해하는 학생들이 과목, 교수에 대해 질문하는 서비스야",
          examples=[
              InputOutputTextPair(
                  input_text="정기숙 교수님 자료구조응용 수업 어때?에서 과목명, 교수명이 뭐야?",
                  output_text="과목명 자료구조응용 교수명 정기숙",
              ),
              InputOutputTextPair(
                  input_text="정기숙 교수님 어때?에서 과목명, 교수명이 뭐야?",
                  output_text="과목명 NULL 교수명 정기숙",
              ),
              InputOutputTextPair(
                  input_text="자료구조응용 수업 어때?에서 과목명, 교수명이 뭐야?",
                  output_text="과목명 자료구조응용 교수명 NULL",
              ),
          ],
          temperature=0.0,
          max_output_tokens=1024,
          top_p=0.8,
          top_k=1
        )

        #LLM에게 질문해서 user의 input으로부터 과목, 교수명 가져오기
        key_query = chat.send_message(query_text+"에서 과목명, 교수명이 뭐야?").text

        #user의 query를 embedding
        inputs = tokenizer(query_text, padding=True, truncation=True, return_tensors="pt")

        embeddings, _ = model(**inputs, return_dict=False)
        embedding_arr = embeddings[0][0].detach().numpy()
        embedding_str = ",".join(str(x) for x in embedding_arr)
        embedding_str = "["+embedding_str+"]"

        lec, prof = extract(key_query)
        print(lec, prof)
        if lec != None and prof != None :    #User의 질문 유형에 맞게 쿼리문 짜줌
          insert_stat, param = (sqlalchemy.text(
                    """SELECT origin_text, rating, assignment, team, grade, attendance, test  FROM PROFNLEC WHERE INFO LIKE :information
                      ORDER BY v <-> :query_vec LIMIT 20"""
          ), {"information": f'%{lec}%{prof}%', "query_vec": embedding_str})

        elif lec != None :
          insert_stat, param = sqlalchemy.text(
                    """SELECT origin_text, rating, assignment, team, grade, attendance, test FROM PROFNLEC WHERE INFO LIKE :lecture
                      ORDER BY v <-> :query_vec LIMIT 20"""
          ), {"lecture": f'%{lec}%', "query_vec": embedding_str}

        elif prof != None :
          insert_stat, param = sqlalchemy.text(
                    """SELECT origin_text, rating, assignment, team, grade, attendance, test FROM PROFNLEC WHERE INFO LIKE :professor
                      ORDER BY v <-> :query_vec LIMIT 20"""
          ), {"professor": f'%{prof}%', "query_vec": embedding_str}

        with pool.connect() as db_conn: # 쿼리 실행문
            result = db_conn.execute(
                insert_stat, parameters = param
            ).fetchall()

        #query 결과를 문자열로 바꾸기 <- Context에는 문자열만 들어갈 수 있음
        articles = ""
        for res in result :
            for qhwh_info in res :
              articles += " " + str(qhwh_info)
        print(articles)

        chat_model = ChatModel.from_pretrained("chat-bison@001")

        output_chat = chat_model.start_chat(
            context="강의를 찾는 대학생들에게 강의평들을 토대로 수업이 어떤지 알려주는 서비스야, 주어진 강의평들을 요약해서 학생들에게 과제는 어떻다, 시험은 어떻다 이런 식으로 키워드별로 알려줘" + articles + "강의평을 가져올 때는 있는 그대로 가져오지 말고 나름대로 요약해서 알려줘, 그리고 대답은 존댓말로 해줘",
            temperature=0.3,
            max_output_tokens=1024,
            top_p=0.8,
            top_k=10
        )

        output = output_chat.send_message(query_text).text
        experiment[f][num_sen[i]][j][query_text] = output

import json

file_path = '/content/drive/MyDrive/Vector_DB_output.json'
with open(file_path, 'w', encoding = 'utf-8') as file :
  json.dump(experiment, file, indent = "\t", ensure_ascii = False)
